[["index.html", "Differential Expression Tutorial Chapter 1 Overview 1.1 Packages 1.2 Reproducibility", " Differential Expression Tutorial BCB420 / Ruth Isserlin Chapter 1 Overview This bookdown tutorial demonstrates differential expression analysis on GSE233947, which provides a FeatureCounts raw-count matrix as a GEO supplementary file (GSE233947_FeatureCounts_V31genes_RawCounts_ENSG.tsv.gz). We implement three DE workflows in clearly separated chapters: limma-voom (Chapter 4) edgeR (quasi-likelihood) (Chapter 5) DESeq2 (Chapter 6) In addition, it also demonstrates the analysis of differential expression analysis on a messy dataset GSE240829, which provides multiple files on GEO, two are TPM and one is labelled as salmon feature counts so for argument’s sake I am going to assume that it is salmon estimated counts (as opposed to TPM, like the other files.). limma-voom (Chapter @ref(limma-voom_dataset2)) edgeR (quasi-likelihood) –&gt; well we try quasi-likelihood (Chapter @ref(edger_dataset2)) DESeq2 (Chapter @ref(deseq2_dataset2)) 1.1 Packages # Install once if needed: if(!require(tidyverse)){ install.packages(c(&quot;tidyverse&quot;)) } library(GEOquery) library(edgeR) library(limma) library(tidyverse) library(ComplexHeatmap) library(RColorBrewer) library(circlize) 1.2 Reproducibility Run this project in RStudio. Click Build → Build Book (or run bookdown::render_book(\"index.Rmd\")). "],["get-data.html", "Chapter 2 Get the data 2.1 Download the GEO supplementary file(s) 2.2 Read the FeatureCounts matrix 2.3 Create metadata from sample names 2.4 Identifier mapping 2.5 Save intermediate objects", " Chapter 2 Get the data 2.1 Download the GEO supplementary file(s) This chapter downloads it automatically using GEOquery. GSE_ID &lt;- &quot;GSE233947&quot; # Download supplementary files into ./data/GSE233947/ # (If already downloaded, GEOquery will reuse existing files.) dir.create(&quot;data&quot;, showWarnings = FALSE) supp &lt;- GEOquery::getGEOSuppFiles( GSE_ID, makeDirectory = TRUE, baseDir = &quot;data&quot; ) 2.2 Read the FeatureCounts matrix counts_file &lt;- file.path(&quot;data&quot;, GSE_ID, &quot;GSE233947_FeatureCounts_V31genes_RawCounts_ENSG.tsv.gz&quot;) stopifnot(file.exists(counts_file)) fc &lt;- readr::read_tsv(counts_file, show_col_types = FALSE) # Peek at the columns names(fc)[1:min(12, ncol(fc))] ## [1] &quot;Gene&quot; &quot;T8657_900CTG_NT&quot; &quot;T8658_1150CTG_NT&quot; &quot;T8659_1450CTG_NT&quot; &quot;T8660_900CTG_20CTG&quot; ## [6] &quot;T8661_1150CTG_20CTG&quot; &quot;T8662_1450CTG_20CTG&quot; &quot;T8663_900CTG_3CTG&quot; &quot;T8664_1150CTG_3CTG&quot; &quot;T8665_1450CTG_3CTG&quot; 2.2.1 Build a counts matrix (genes × samples) sample_cols &lt;- colnames(fc) counts &lt;- fc %&gt;% dplyr::select( all_of(sample_cols)) %&gt;% as.data.frame() rownames(counts) &lt;- counts$Gene counts$Gene &lt;- NULL counts &lt;- as.matrix(counts) storage.mode(counts) &lt;- &quot;integer&quot; dim(counts) ## [1] 62248 9 counts[1:3, 1:3] ## T8657_900CTG_NT T8658_1150CTG_NT T8659_1450CTG_NT ## ENSG00000108821 456397 486088 608151 ## ENSG00000265150 170681 299425 286295 ## ENSG00000164692 169781 190854 263391 2.3 Create metadata from sample names Sample names in this series follow patterns like: 900CTG_NT 900CTG_3'CTG 900CTG_20CTG We will parse: cellline: 900CTG, 1150CTG, 1450CTG treatment: NT, 3CTG, 20CTG #design matrix - samples &lt;- colnames(counts)[1:ncol(counts)] cellline &lt;- unlist(lapply(samples,FUN = function(x){unlist(strsplit(x,split = &quot;_&quot;))[2]})) treatment &lt;- unlist(lapply(samples,FUN = function(x){unlist(strsplit(x,split = &quot;_&quot;))[3]})) meta &lt;- data.frame(samples, cellline, treatment) 2.4 Identifier mapping strip_ensembl_version &lt;- function(x) sub(&quot;\\\\..*$&quot;, &quot;&quot;, x) kable_head &lt;- function(x, n = 5, caption = NULL) { knitr::kable(utils::head(x, n), caption = caption) } mapped_counts &lt;- data.frame(ensembl_gene_id = rownames(counts),counts) ids&lt;- mapped_counts$ensembl_gene_id if (any(grepl(&quot;^ENSG&quot;, strip_ensembl_version(ids)))) { library(biomaRt) ensembl_ids &lt;- unique(strip_ensembl_version(ids)) ensembl &lt;- useMart(&quot;ensembl&quot;, dataset = &quot;hsapiens_gene_ensembl&quot;) map &lt;- getBM( attributes = c(&quot;ensembl_gene_id&quot;, &quot;hgnc_symbol&quot;), filters = &quot;ensembl_gene_id&quot;, values = ensembl_ids, mart = ensembl ) kable_head(map, 10, paste(&quot;: mapping preview&quot;)) counts_mapped &lt;- mapped_counts %&gt;% left_join(map, by = &quot;ensembl_gene_id&quot;) %&gt;% dplyr::select( ensembl_gene_id,hgnc_symbol, everything()) kable_head(counts_mapped[, 1:min(8, ncol(counts_mapped))], 5, paste(&quot;: mapped table preview&quot;)) } Table 2.1: : mapped table preview ensembl_gene_id hgnc_symbol T8657_900CTG_NT T8658_1150CTG_NT T8659_1450CTG_NT T8660_900CTG_20CTG T8661_1150CTG_20CTG T8662_1450CTG_20CTG ENSG00000108821 COL1A1 456397 486088 608151 2012962 379186 474716 ENSG00000265150 NA 170681 299425 286295 747000 210962 148756 ENSG00000164692 COL1A2 169781 190854 263391 869194 180006 217321 ENSG00000265735 RN7SL5P 78113 121697 113379 532435 112977 75960 ENSG00000259001 55081 78811 73032 353442 100823 118293 2.5 Save intermediate objects saveRDS(list(counts = counts, meta = meta, mappings = counts_mapped[,1:2]), file = &quot;data/d1_counts_and_meta.rds&quot;) "],["qc.html", "Chapter 3 QC, filtering and identifier mapping 3.1 Filter lowly expressed genes 3.2 TMM normalization 3.3 Exploratory MDS plot 3.4 Exploratory MDS plot - coloured by cellline 3.5 log-CPM for visualization 3.6 Save for downstream chapters", " Chapter 3 QC, filtering and identifier mapping This chapter performs shared QC steps used by both limma-voom and edgeR and DEseq2. obj &lt;- readRDS(&quot;data/d1_counts_and_meta.rds&quot;) counts &lt;- obj$counts meta &lt;- obj$meta mappings &lt;- obj$mappings # Create a DGEList (edgeR data container) dge &lt;- edgeR::DGEList(counts = counts) # Attach metadata # (not required, but helpful) dge$samples &lt;- cbind(dge$samples, meta) dge$samples ## group lib.size norm.factors samples cellline treatment ## T8657_900CTG_NT 1 6630521 1 T8657_900CTG_NT 900CTG NT ## T8658_1150CTG_NT 1 6385596 1 T8658_1150CTG_NT 1150CTG NT ## T8659_1450CTG_NT 1 6736405 1 T8659_1450CTG_NT 1450CTG NT ## T8660_900CTG_20CTG 1 21407865 1 T8660_900CTG_20CTG 900CTG 20CTG ## T8661_1150CTG_20CTG 1 7300059 1 T8661_1150CTG_20CTG 1150CTG 20CTG ## T8662_1450CTG_20CTG 1 8906566 1 T8662_1450CTG_20CTG 1450CTG 20CTG ## T8663_900CTG_3CTG 1 15363308 1 T8663_900CTG_3CTG 900CTG 3CTG ## T8664_1150CTG_3CTG 1 5742524 1 T8664_1150CTG_3CTG 1150CTG 3CTG ## T8665_1450CTG_3CTG 1 8150376 1 T8665_1450CTG_3CTG 1450CTG 3CTG 3.1 Filter lowly expressed genes We use filterByExpr with the intended design to remove genes with insufficient counts. design &lt;- model.matrix(~ 0 + treatment+ cellline, data = meta) keep &lt;- edgeR::filterByExpr(dge, design) dge_f &lt;- dge[keep, , keep.lib.sizes = FALSE] dim(dge) ## [1] 62248 9 dim(dge_f) ## [1] 14704 9 #create a subset of the gene mappings counts_mapped_filtered &lt;- counts_mapped[counts_mapped$ensembl_gene_id %in% rownames(dge_f$counts),] 3.2 TMM normalization dge_f &lt;- edgeR::calcNormFactors(dge_f, method = &quot;TMM&quot;) dge_f$samples ## group lib.size norm.factors samples cellline treatment ## T8657_900CTG_NT 1 6613352 0.9864614 T8657_900CTG_NT 900CTG NT ## T8658_1150CTG_NT 1 6367769 0.9803205 T8658_1150CTG_NT 1150CTG NT ## T8659_1450CTG_NT 1 6717956 0.9780540 T8659_1450CTG_NT 1450CTG NT ## T8660_900CTG_20CTG 1 21352764 0.7819891 T8660_900CTG_20CTG 900CTG 20CTG ## T8661_1150CTG_20CTG 1 7281383 1.0270153 T8661_1150CTG_20CTG 1150CTG 20CTG ## T8662_1450CTG_20CTG 1 8881365 1.0925886 T8662_1450CTG_20CTG 1450CTG 20CTG ## T8663_900CTG_3CTG 1 15312842 1.1129527 T8663_900CTG_3CTG 900CTG 3CTG ## T8664_1150CTG_3CTG 1 5727579 1.0131443 T8664_1150CTG_3CTG 1150CTG 3CTG ## T8665_1450CTG_3CTG 1 8127572 1.0685791 T8665_1450CTG_3CTG 1450CTG 3CTG 3.3 Exploratory MDS plot current_colors &lt;- RColorBrewer::brewer.pal(n = length(unique(meta$treatment)), &quot;Set2&quot;) names(current_colors) &lt;- levels(factor(meta$treatment)) plotMDS(dge_f, labels = meta$treatment, col = current_colors[meta$treatment], main = &quot;MDS plot (colored by treatment)&quot; ) legend(&quot;topright&quot;, legend = names(current_colors), col = current_colors, pch = 16, bty = &quot;n&quot; ) 3.4 Exploratory MDS plot - coloured by cellline current_colors_cellline &lt;- RColorBrewer::brewer.pal(n = length(unique(meta$cellline)), &quot;Set1&quot;) names(current_colors_cellline) &lt;- levels(factor(meta$cellline)) plotMDS(dge_f, labels = meta$cellline, col = current_colors_cellline[meta$cellline], main = &quot;MDS plot (colored by cellline)&quot; ) legend(&quot;topright&quot;, legend = names(current_colors_cellline), col = current_colors_cellline, pch = 16, bty = &quot;n&quot; ) 3.5 log-CPM for visualization lcpm &lt;- edgeR::cpm(dge_f, log = TRUE, prior.count = 1) summary(as.vector(lcpm)) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## -3.235 2.148 3.998 3.847 5.480 16.879 3.6 Save for downstream chapters saveRDS(list(dge_f = dge_f, meta = meta, design = design, lcpm = lcpm, mappings = mappings), file = &quot;data/d1_qc_objects.rds&quot;) "],["limma-voom.html", "Chapter 4 Differential expression with limma-voom 4.1 Results tables 4.2 Volcano plot (20CTG vs NT) 4.3 Save limma results", " Chapter 4 Differential expression with limma-voom In this chapter we run limma-voom, which: Starts from raw counts Transforms to log2-CPM with precision weights (voom()) Fits a linear model + empirical Bayes moderation We use an additive model: \\[ \\text{expression} \\sim \\text{cellline} + \\text{treatment} \\] This estimates treatment effects while controlling for baseline differences between cell lines. obj &lt;- readRDS(&quot;data/d1_qc_objects.rds&quot;) dge_f &lt;- obj$dge_f meta &lt;- obj$meta mappings &lt;- obj$mappings design &lt;- obj$design v &lt;- limma::voom(dge_f, design, plot = TRUE) fit &lt;- limma::lmFit(v, design) fit &lt;- limma::eBayes(fit, trend = TRUE) # Contrasts contr &lt;- limma::makeContrasts( `3CTG_vs_NT` = treatment3CTG - treatmentNT, `20CTG_vs_NT` = treatment20CTG - treatmentNT, `20CTG_vs_3CTG` = treatment20CTG - treatment3CTG, levels = design ) fit2 &lt;- limma::contrasts.fit(fit, contr) fit2 &lt;- limma::eBayes(fit2, trend = TRUE) 4.1 Results tables res_3_vs_nt &lt;- limma::topTable(fit2, coef = &quot;3CTG_vs_NT&quot;, number = Inf, sort.by = &quot;P&quot;) res_20_vs_nt &lt;- limma::topTable(fit2, coef = &quot;20CTG_vs_NT&quot;, number = Inf, sort.by = &quot;P&quot;) res_20_vs_3 &lt;- limma::topTable(fit2, coef = &quot;20CTG_vs_3CTG&quot;, number = Inf, sort.by = &quot;P&quot;) head(res_20_vs_nt) ## logFC AveExpr t P.Value adj.P.Val B ## ENSG00000106785 2.894374 5.240704 11.266490 1.873824e-06 0.01003629 5.647001 ## ENSG00000142627 3.454754 3.004435 11.155273 2.031112e-06 0.01003629 5.208978 ## ENSG00000187608 4.500617 7.640307 10.951816 2.358174e-06 0.01003629 5.464044 ## ENSG00000130303 5.000484 3.008775 10.755364 2.730221e-06 0.01003629 4.811748 ## ENSG00000184979 3.072986 4.117137 9.857263 5.502788e-06 0.01072873 4.582496 ## ENSG00000173535 3.674226 2.015635 9.825163 5.648037e-06 0.01072873 4.065739 4.2 Volcano plot (20CTG vs NT) volcano_df &lt;- res_20_vs_nt %&gt;% rownames_to_column(&quot;ensembl&quot;) %&gt;% mutate(sig = adj.P.Val &lt; 0.05) ggplot(volcano_df, aes(x = logFC, y = -log10(P.Value), color = sig)) + geom_point(alpha = 0.6) + theme_minimal() + labs( title = &quot;limma-voom: 20CTG vs NT&quot;, x = &quot;log2 fold-change&quot;, y = &quot;-log10(p-value)&quot; ) 4.3 Save limma results saveRDS( list( meta = meta, counts_mapped_filtered = counts_mapped_filtered, fit2 = fit2, res_3_vs_nt = res_3_vs_nt, res_20_vs_nt = res_20_vs_nt, res_20_vs_3 = res_20_vs_3 ), file = &quot;data/d1_limma_results.rds&quot; ) "],["edger.html", "Chapter 5 Differential expression with edgeR (QLF) 5.1 Plot Biological coefficient of variance plot 5.2 Test: 3CTG vs NT and 20CTG vs NT 5.3 Test: 20CTG vs 3CTG 5.4 Extract full results 5.5 Volcano plot of EdgeR results 5.6 Visualize the top hits as a heatmap 5.7 Select top hits from tab_20_vs_nt_annot 5.8 Make the expression matrix for the heatmap (logCPM + row z-score) 5.9 Sample annotation (treatment + cellline) using Set3 5.10 5) Draw the ComplexHeatmap heatmap 5.11 Save edgeR results", " Chapter 5 Differential expression with edgeR (QLF) In this chapter we run edgeR using the recommended quasi-likelihood pipeline: Start from raw counts in a DGEList Estimate dispersions Fit a QL GLM Perform QL F-tests for contrasts of interest We use the same additive design: \\[ \\text{counts} \\sim \\text{cellline} + \\text{treatment} \\] obj &lt;- readRDS(&quot;data/d1_qc_objects.rds&quot;) dge_f &lt;- obj$dge_f meta &lt;- obj$meta mappings &lt;- obj$mappings design &lt;- obj$design # Contrasts contr &lt;- makeContrasts( `3CTG_vs_NT` = treatment3CTG - treatmentNT, `20CTG_vs_NT` = treatment20CTG - treatmentNT, `20CTG_vs_3CTG` = treatment20CTG - treatment3CTG, levels = design ) # Estimate dispersion and fit QL model edge &lt;- edgeR::estimateDisp(dge_f, design) fit &lt;- edgeR::glmQLFit(edge, design) 5.1 Plot Biological coefficient of variance plot plotBCV(edge) 5.2 Test: 3CTG vs NT and 20CTG vs NT With this design, the coefficients treatment3CTG and treatment20CTG correspond to contrasts vs NT. qlf_3_vs_nt &lt;- edgeR::glmQLFTest(fit, contrast = contr[, &quot;3CTG_vs_NT&quot;]) qlf_20_vs_nt &lt;- edgeR::glmQLFTest(fit, contrast = contr[, &quot;20CTG_vs_NT&quot;]) edgeR::topTags(qlf_20_vs_nt) ## Coefficient: 1*treatment20CTG -1*treatmentNT ## logFC logCPM F PValue FDR ## ENSG00000134321 7.394417 4.870993 154.68256 1.329498e-07 0.0008950585 ## ENSG00000028277 5.415078 2.672833 115.06349 1.342554e-07 0.0008950585 ## ENSG00000130303 4.851522 4.759055 126.22056 2.336858e-07 0.0008950585 ## ENSG00000142627 3.506374 3.654145 136.69159 2.434871e-07 0.0008950585 ## ENSG00000138646 5.134338 3.601337 118.40507 3.291525e-07 0.0009679716 ## ENSG00000106785 2.887412 5.773032 116.76336 5.126668e-07 0.0012563753 ## ENSG00000173535 3.773864 2.895942 107.75445 6.975318e-07 0.0013657287 ## ENSG00000187608 4.541247 8.814995 108.12725 7.430515e-07 0.0013657287 ## ENSG00000135114 5.347384 2.941023 80.44935 9.846400e-07 0.0015619173 ## ENSG00000184979 3.086410 4.887186 100.50212 1.062240e-06 0.0015619173 5.3 Test: 20CTG vs 3CTG qlf_20_vs_3 &lt;- edgeR::glmQLFTest(fit, contrast = contr[, &quot;20CTG_vs_3CTG&quot;]) edgeR::topTags(qlf_20_vs_3) ## Coefficient: 1*treatment20CTG -1*treatment3CTG ## logFC logCPM F PValue FDR ## ENSG00000223883 -3.221550 -0.29165168 23.13003 0.0007347709 0.9209883 ## ENSG00000280800 3.972084 3.13680001 14.61103 0.0021195502 0.9209883 ## ENSG00000187672 -1.503998 1.40149268 15.71926 0.0024475763 0.9209883 ## ENSG00000115266 1.654827 0.81019376 15.52729 0.0024905149 0.9209883 ## ENSG00000147586 1.290415 1.60657763 15.29760 0.0026685337 0.9209883 ## ENSG00000241781 3.766968 0.09488949 13.92006 0.0029691485 0.9209883 ## ENSG00000102003 1.980855 0.22390723 14.43907 0.0030659698 0.9209883 ## ENSG00000105357 1.886779 1.69377897 13.10103 0.0032984753 0.9209883 ## ENSG00000184524 1.631481 1.49875360 13.57196 0.0036287558 0.9209883 ## ENSG00000260630 0.986704 3.53676750 13.59760 0.0038688768 0.9209883 5.4 Extract full results tab_3_vs_nt &lt;- edgeR::topTags(qlf_3_vs_nt, n = Inf)$table %&gt;% rownames_to_column(&quot;ensembl&quot;) tab_20_vs_nt &lt;- edgeR::topTags(qlf_20_vs_nt, n = Inf)$table %&gt;% rownames_to_column(&quot;ensembl&quot;) tab_20_vs_3 &lt;- edgeR::topTags(qlf_20_vs_3, n = Inf)$table %&gt;% rownames_to_column(&quot;ensembl&quot;) head(tab_20_vs_nt) ## ensembl logFC logCPM F PValue FDR ## 1 ENSG00000134321 7.394417 4.870993 154.6826 1.329498e-07 0.0008950585 ## 2 ENSG00000028277 5.415078 2.672833 115.0635 1.342554e-07 0.0008950585 ## 3 ENSG00000130303 4.851522 4.759055 126.2206 2.336858e-07 0.0008950585 ## 4 ENSG00000142627 3.506374 3.654145 136.6916 2.434871e-07 0.0008950585 ## 5 ENSG00000138646 5.134338 3.601337 118.4051 3.291525e-07 0.0009679716 ## 6 ENSG00000106785 2.887412 5.773032 116.7634 5.126668e-07 0.0012563753 5.5 Volcano plot of EdgeR results volcano_df &lt;- tab_20_vs_nt %&gt;% mutate(sig = FDR &lt; 0.05) ggplot(volcano_df, aes(x = logFC, y = -log10(PValue), color = sig)) + geom_point(alpha = 0.6) + theme_minimal() + labs( title = &quot;EdgeR: 20CTG vs NT&quot;, x = &quot;log2 fold-change&quot;, y = &quot;-log10(p-value)&quot; ) tab &lt;- topTags(qlf_20_vs_nt, n = Inf)$table %&gt;% rownames_to_column(&quot;gene&quot;) %&gt;% mutate( neglog10P = -log10(PValue), direction = case_when( FDR &lt; 0.05 &amp; logFC &gt; 0 ~ &quot;Up&quot;, FDR &lt; 0.05 &amp; logFC &lt; 0 ~ &quot;Down&quot;, TRUE ~ &quot;Not sig&quot; ) ) ggplot(tab, aes(x = logFC, y = neglog10P)) + geom_point(aes(color = direction), alpha = 0.7, size = 1.2) + scale_color_manual(values = c( &quot;Up&quot; = &quot;red&quot;, &quot;Down&quot; = &quot;blue&quot;, &quot;Not sig&quot; = &quot;grey70&quot; )) + geom_vline(xintercept = c(-1, 1), linetype = &quot;dashed&quot;, color = &quot;steelblue&quot;) + geom_hline(yintercept = -log10(0.05), linetype = &quot;dashed&quot;, color = &quot;steelblue&quot;) + theme_minimal() + labs( title = &quot;edgeR volcano: 20CTG vs NT&quot;, x = &quot;log2 fold change (logFC)&quot;, y = &quot;-log10(p-value)&quot;, color = NULL ) 5.6 Visualize the top hits as a heatmap first map the ensembl ids to gene ids # Keep only the columns we need and ensure they are character map_df &lt;- mappings %&gt;% transmute( ensembl = as.character(ensembl_gene_id), hgnc_symbol = as.character(hgnc_symbol) ) %&gt;% distinct(ensembl, .keep_all = TRUE) # Join mapping onto the edgeR results table (tab_20_vs_nt) tab_20_vs_nt_annot &lt;- tab_20_vs_nt %&gt;% mutate(ensembl = as.character(ensembl)) %&gt;% left_join(map_df, by = &quot;ensembl&quot;) %&gt;% mutate( # Use HGNC when available, otherwise fall back to Ensembl display_name = ifelse(!is.na(hgnc_symbol) &amp; hgnc_symbol != &quot;&quot;, hgnc_symbol, ensembl) ) # Quick check: how many mapped? mean(!is.na(tab_20_vs_nt_annot$hgnc_symbol)) ## [1] 0.9876904 head(tab_20_vs_nt_annot[, c(&quot;ensembl&quot;,&quot;hgnc_symbol&quot;,&quot;display_name&quot;,&quot;logFC&quot;,&quot;FDR&quot;)]) ## ensembl hgnc_symbol display_name logFC FDR ## 1 ENSG00000134321 RSAD2 RSAD2 7.394417 0.0008950585 ## 2 ENSG00000028277 POU2F2 POU2F2 5.415078 0.0008950585 ## 3 ENSG00000130303 BST2 BST2 4.851522 0.0008950585 ## 4 ENSG00000142627 EPHA2 EPHA2 3.506374 0.0008950585 ## 5 ENSG00000138646 HERC5 HERC5 5.134338 0.0009679716 ## 6 ENSG00000106785 TRIM14 TRIM14 2.887412 0.0012563753 5.7 Select top hits from tab_20_vs_nt_annot Pick either top N by FDR (good default for teaching) or all genes with FDR &lt; 0.05. 5.7.1 top N genes by FDR top_n &lt;- 50 # change to 25/100 as desired top_hits_tbl &lt;- tab_20_vs_nt_annot %&gt;% arrange(FDR, PValue) %&gt;% slice_head(n = top_n) # Ensembl IDs for subsetting the matrix top_hits_ensembl &lt;- top_hits_tbl$ensembl # Row labels we want to show on the heatmap top_hits_labels &lt;- top_hits_tbl$display_name head(top_hits_tbl[, c(&quot;ensembl&quot;,&quot;display_name&quot;,&quot;logFC&quot;,&quot;FDR&quot;)]) ## ensembl display_name logFC FDR ## 1 ENSG00000134321 RSAD2 7.394417 0.0008950585 ## 2 ENSG00000028277 POU2F2 5.415078 0.0008950585 ## 3 ENSG00000130303 BST2 4.851522 0.0008950585 ## 4 ENSG00000142627 EPHA2 3.506374 0.0008950585 ## 5 ENSG00000138646 HERC5 5.134338 0.0009679716 ## 6 ENSG00000106785 TRIM14 2.887412 0.0012563753 5.8 Make the expression matrix for the heatmap (logCPM + row z-score) We’ll compute logCPM from counts (recommended for visualization), then z-score per gene. # logCPM from counts for visualization # logCPM for visualization logcpm &lt;- edgeR::cpm(counts, log = TRUE, prior.count = 1) # Keep only genes present in the expression matrix keep &lt;- top_hits_ensembl %in% rownames(logcpm) hm_mat &lt;- logcpm[top_hits_ensembl[keep], , drop = FALSE] # Create labels aligned to hm_mat rows hm_labels &lt;- top_hits_labels[keep] # IMPORTANT: avoid duplicate rownames (HGNC symbols can repeat) # Make labels unique while preserving readability rownames(hm_mat) &lt;- make.unique(hm_labels) # Z-score per gene across samples for pattern visibility hm_z &lt;- t(scale(t(hm_mat))) dim(hm_z) ## [1] 50 9 5.9 Sample annotation (treatment + cellline) using Set3 meta$cellline &lt;- as.factor(meta$cellline) meta$treatment &lt;- as.factor(meta$treatment) # Set3 palettes (qualitative) treat_levels &lt;- levels(meta$treatment) cell_levels &lt;- levels(meta$cellline) treat_cols &lt;- setNames( brewer.pal(max(3, length(treat_levels)), &quot;Set3&quot;)[seq_along(treat_levels)], treat_levels ) cell_cols &lt;- setNames( brewer.pal(max(3, length(cell_levels)), &quot;Set2&quot;)[seq_along(cell_levels)], cell_levels ) ha &lt;- HeatmapAnnotation( treatment = meta$treatment, cellline = meta$cellline, col = list( treatment = treat_cols, cellline = cell_cols ), annotation_legend_param = list( treatment = list(title = &quot;Treatment&quot;), cellline = list(title = &quot;Cell line&quot;) ) ) 5.10 5) Draw the ComplexHeatmap heatmap This produces the actual figure. Since we z-scored the rows, use a diverging palette centered at 0. col_fun &lt;- circlize::colorRamp2(c(-2, 0, 2), c(&quot;blue&quot;, &quot;white&quot;, &quot;red&quot;)) Heatmap( hm_z, col = col_fun, top_annotation = ha, show_row_names = FALSE, show_column_names = FALSE, cluster_rows = TRUE, cluster_columns = TRUE, row_title = paste0(&quot;Top &quot;, nrow(hm_z), &quot; genes (edgeR: 20CTG vs NT)&quot;), column_title = &quot;Samples&quot; ) Add labels of the gene names - only include 25 of the top hit for easier visibility. Is this the correct way to add the top 25? Heatmap( hm_z[1:25,], col = col_fun, top_annotation = ha, show_row_names = TRUE, # &lt;-- now shows HGNC symbols row_names_gp = grid::gpar(fontsize = 8), show_column_names = FALSE, cluster_rows = TRUE, cluster_columns = TRUE, row_title = paste0(&quot;Top &quot;, nrow(hm_z), &quot; genes (edgeR: 20CTG vs NT)&quot;), column_title = &quot;Samples&quot; ) 5.11 Save edgeR results saveRDS( list( meta = meta, counts_mapped_filtered = counts_mapped_filtered, fit = fit, qlf_3_vs_nt = qlf_3_vs_nt, qlf_20_vs_nt = qlf_20_vs_nt, qlf_20_vs_3 = qlf_20_vs_3, tab_3_vs_nt = tab_3_vs_nt, tab_20_vs_nt = tab_20_vs_nt, tab_20_vs_3 = tab_20_vs_3 ), file = &quot;data/d1_edger_results.rds&quot; ) "],["deseq2.html", "Chapter 6 Differential expression with DESeq2 6.1 Results 6.2 Volcano (red=up, blue=down)", " Chapter 6 Differential expression with DESeq2 DESeq2 performs differential expression analysis for RNA-seq count data. obj &lt;- readRDS(&quot;data/d1_qc_objects.rds&quot;) dge_f &lt;- obj$dge_f meta &lt;- obj$meta library(DESeq2) count_mat &lt;- dge_f$counts storage.mode(count_mat) &lt;- &quot;integer&quot; stopifnot(all(colnames(count_mat) == meta$sample)) dds &lt;- DESeqDataSetFromMatrix( countData = count_mat, colData = as.data.frame(meta), design = ~ cellline + treatment ) dds &lt;- DESeq(dds) 6.1 Results res_20_vs_nt &lt;- results(dds, contrast = c(&quot;treatment&quot;, &quot;20CTG&quot;, &quot;NT&quot;)) res_3_vs_nt &lt;- results(dds, contrast = c(&quot;treatment&quot;, &quot;3CTG&quot;, &quot;NT&quot;)) res_20_vs_3 &lt;- results(dds, contrast = c(&quot;treatment&quot;, &quot;20CTG&quot;, &quot;3CTG&quot;)) summary(res_20_vs_nt) ## ## out of 14704 with nonzero total read count ## adjusted p-value &lt; 0.1 ## LFC &gt; 0 (up) : 541, 3.7% ## LFC &lt; 0 (down) : 225, 1.5% ## outliers [1] : 0, 0% ## low counts [2] : 0, 0% ## (mean count &lt; 4) ## [1] see &#39;cooksCutoff&#39; argument of ?results ## [2] see &#39;independentFiltering&#39; argument of ?results 6.2 Volcano (red=up, blue=down) library(ggplot2) library(dplyr) library(tibble) vol &lt;- as.data.frame(res_20_vs_nt) %&gt;% rownames_to_column(&quot;gene&quot;) %&gt;% mutate( neglog10p = -log10(pvalue), direction = case_when( !is.na(padj) &amp; padj &lt; 0.05 &amp; log2FoldChange &gt; 0 ~ &quot;Up&quot;, !is.na(padj) &amp; padj &lt; 0.05 &amp; log2FoldChange &lt; 0 ~ &quot;Down&quot;, TRUE ~ &quot;Not sig&quot; ) ) ggplot(vol, aes(log2FoldChange, neglog10p)) + geom_point(aes(color = direction), alpha = 0.7, size = 1.2) + scale_color_manual(values = c(Up = &quot;red&quot;, Down = &quot;blue&quot;, `Not sig` = &quot;grey70&quot;)) + theme_minimal() + labs(title = &quot;DESeq2: 20CTG vs NT&quot;, x = &quot;log2 FC&quot;, y = &quot;-log10(p)&quot;, color = NULL) saveRDS(list(meta = meta, dds = dds, res_20_vs_nt = res_20_vs_nt, res_3_vs_nt = res_3_vs_nt, res_20_vs_3 = res_20_vs_3), file = &quot;data/d1_deseq2_results.rds&quot;) "],["get-data_dataset2.html", "Chapter 7 Get the data - Dataset 2 7.1 Download the GEO supplementary file(s) 7.2 Read the FeatureCounts matrix 7.3 Create metadata from sample names 7.4 Identifier mapping 7.5 Save intermediate objects", " Chapter 7 Get the data - Dataset 2 7.1 Download the GEO supplementary file(s) This chapter downloads it automatically using GEOquery. GSE_ID &lt;- &quot;GSE240829&quot; # Download supplementary files into ./data/GSE240829/ # (If already downloaded, GEOquery will reuse existing files.) dir.create(&quot;data&quot;, showWarnings = FALSE) supp &lt;- GEOquery::getGEOSuppFiles( GSE_ID, makeDirectory = TRUE, baseDir = &quot;data&quot; ) 7.2 Read the FeatureCounts matrix counts_file &lt;- file.path(&quot;data&quot;, GSE_ID, &quot;GSE240829_POCROC_good.abundance.salmon.genes_8.14.23.txt.gz&quot;) stopifnot(file.exists(counts_file)) fc &lt;- readr::read_tsv(counts_file, show_col_types = FALSE) # Peek at the columns names(fc)[1:min(12, ncol(fc))] ## [1] &quot;...1&quot; &quot;21020_0_ovary&quot; &quot;21020_2_lymph_node&quot; &quot;24487_0_l_ovary&quot; &quot;24487_1_lymph_node&quot; &quot;25258_0_l_ovary&quot; ## [7] &quot;25258_1_diaphragm&quot; &quot;29764_0_l_ovary&quot; &quot;30961_0_r_ovary&quot; &quot;30961_3_rectum&quot; &quot;32761_0_l_ovary&quot; &quot;32761_2_spleen&quot; 7.2.1 Build a counts matrix (genes × samples) sample_cols &lt;- colnames(fc) counts &lt;- fc %&gt;% dplyr::select( all_of(sample_cols)) %&gt;% as.data.frame() rownames(counts) &lt;- counts[,1] counts[,1] &lt;- NULL counts &lt;- as.matrix(counts) #storage.mode(counts) &lt;- &quot;integer&quot; dim(counts) ## [1] 33969 43 counts[1:3, 1:3] ## 21020_0_ovary 21020_2_lymph_node 24487_0_l_ovary ## ENSG00000230092.7 10.718211 4.244121 2.959815 ## ENSG00000177757.2 0.018135 0.025687 0.070439 ## ENSG00000228794.8 2.335282 2.654898 0.616134 7.3 Create metadata from sample names Sample names in this series follow patterns like: 21020_0_ovary 21020_2_lymph_node 24487_0_l_ovary … Where the first number is the patient id, second number is whether it is primary or recurrent and the third is location. It was separated really badly because there are underscores in the location name as well. (l_ovary = left ovary). –&gt; just grab the last token for the location We will parse: ‘patient’ - patient id ‘status’ - primary, recurrent1, recurrent2, recurrent3 ‘location’ - ovary, #design matrix - samples &lt;- colnames(counts)[1:ncol(counts)] patient &lt;- unlist(lapply(samples,FUN = function(x){unlist(strsplit(x,split = &quot;_&quot;))[1]})) status &lt;- unlist(lapply(samples,FUN = function(x){unlist(strsplit(x,split = &quot;_&quot;))[2]})) location &lt;- unlist(lapply(samples,FUN = function(x){ if(length(unlist(strsplit(x, &quot;_&quot;))) &gt; 3){ y &lt;- paste(unlist(strsplit(x, &quot;_&quot;))[3:length(unlist(strsplit(x, &quot;_&quot;)))],collapse =&quot;_&quot;) } else{ y &lt;- unlist(strsplit(x, &quot;_&quot;))[3] } return(y) })) meta &lt;- data.frame(samples, patient,status, location) 7.4 Identifier mapping strip_ensembl_version &lt;- function(x) sub(&quot;\\\\..*$&quot;, &quot;&quot;, x) kable_head &lt;- function(x, n = 5, caption = NULL) { knitr::kable(utils::head(x, n), caption = caption) } mapped_counts &lt;- data.frame(ensembl_gene_id = strip_ensembl_version(rownames(counts)),counts) ids&lt;- mapped_counts$ensembl_gene_id if (any(grepl(&quot;^ENSG&quot;, strip_ensembl_version(ids)))) { library(biomaRt) ensembl_ids &lt;- unique(strip_ensembl_version(ids)) ensembl &lt;- useMart(&quot;ensembl&quot;, dataset = &quot;hsapiens_gene_ensembl&quot;) map &lt;- getBM( attributes = c(&quot;ensembl_gene_id&quot;, &quot;hgnc_symbol&quot;), filters = &quot;ensembl_gene_id&quot;, values = ensembl_ids, mart = ensembl ) kable_head(map, 10, paste(&quot;: mapping preview&quot;)) counts_mapped &lt;- mapped_counts %&gt;% left_join(map, by = &quot;ensembl_gene_id&quot;) %&gt;% dplyr::select( ensembl_gene_id,hgnc_symbol, everything()) kable_head(counts_mapped[, 1:min(8, ncol(counts_mapped))], 5, paste(&quot;: mapped table preview&quot;)) } Table 7.1: : mapped table preview ensembl_gene_id hgnc_symbol X21020_0_ovary X21020_2_lymph_node X24487_0_l_ovary X24487_1_lymph_node X25258_0_l_ovary X25258_1_diaphragm ENSG00000230092 10.718211 4.244121 2.959815 1.920198 1.591502 0.695518 ENSG00000177757 FAM87B 0.018135 0.025687 0.070439 0.031852 0.005534 0.000000 ENSG00000228794 LINC01128 2.335282 2.654898 0.616134 0.635164 0.477670 0.851483 ENSG00000225880 LINC00115 0.425905 0.396866 0.313534 0.296781 0.125387 0.249801 ENSG00000230368 FAM41C 0.230066 0.409599 0.420536 0.126110 0.165970 0.029084 7.5 Save intermediate objects saveRDS(list(counts = counts, meta = meta, mappings = counts_mapped[,1:2]), file = &quot;data/d2_counts_and_meta.rds&quot;) "],["qc_dataset2.html", "Chapter 8 QC, filtering and identifier mapping - Dataset 2 8.1 Load in the data 8.2 Simplify this model 8.3 Filter lowly expressed genes 8.4 TMM normalization 8.5 Exploratory MDS plot 8.6 Exploratory MDS plot - coloured by patient 8.7 log-CPM for visualization 8.8 Save for downstream chapters", " Chapter 8 QC, filtering and identifier mapping - Dataset 2 This chapter performs shared QC steps used by both limma-voom and edgeR and DEseq2. 8.1 Load in the data obj &lt;- readRDS(&quot;data/d2_counts_and_meta.rds&quot;) counts &lt;- obj$counts meta &lt;- obj$meta mappings &lt;- obj$mappings 8.2 Simplify this model Too many variables in this dataset - reduce the data to just two statuses - 0 or 1 meta &lt;- meta[(meta$status == 0 | meta$status == 1),] counts &lt;- counts[,meta$samples] # Create a DGEList (edgeR data container) dge &lt;- edgeR::DGEList(counts = counts) # Attach metadata # (not required, but helpful) dge$samples &lt;- cbind(dge$samples, meta) dge$samples ## group lib.size norm.factors samples patient status location ## 21020_0_ovary 1 271721.5 1 21020_0_ovary 21020 0 ovary ## 24487_0_l_ovary 1 249346.0 1 24487_0_l_ovary 24487 0 l_ovary ## 24487_1_lymph_node 1 409691.0 1 24487_1_lymph_node 24487 1 lymph_node ## 25258_0_l_ovary 1 152643.4 1 25258_0_l_ovary 25258 0 l_ovary ## 25258_1_diaphragm 1 326043.7 1 25258_1_diaphragm 25258 1 diaphragm ## 29764_0_l_ovary 1 221138.0 1 29764_0_l_ovary 29764 0 l_ovary ## 30961_0_r_ovary 1 239212.0 1 30961_0_r_ovary 30961 0 r_ovary ## 32761_0_l_ovary 1 285745.9 1 32761_0_l_ovary 32761 0 l_ovary ## 37306_0_omentum 1 311885.4 1 37306_0_omentum 37306 0 omentum ## 40729_0_l_ovary 1 323621.3 1 40729_0_l_ovary 40729 0 l_ovary ## 41323_0_omentum 1 241791.8 1 41323_0_omentum 41323 0 omentum ## 45097_0_r_adnexa 1 333289.2 1 45097_0_r_adnexa 45097 0 r_adnexa ## 45097_1_lymph_node 1 356872.5 1 45097_1_lymph_node 45097 1 lymph_node ## 47573_0_l_ovary 1 262786.0 1 47573_0_l_ovary 47573 0 l_ovary ## 47573_1_lymph_node 1 312630.0 1 47573_1_lymph_node 47573 1 lymph_node ## 48986_0_r_ovary 1 264397.8 1 48986_0_r_ovary 48986 0 r_ovary ## 48986_1_abd_wall 1 239510.2 1 48986_1_abd_wall 48986 1 abd_wall ## 16030_0_l_ovary 1 276078.6 1 16030_0_l_ovary 16030 0 l_ovary ## 16030_1_pelvis 1 329090.6 1 16030_1_pelvis 16030 1 pelvis ## 18975_0_l_adenexa 1 120959.6 1 18975_0_l_adenexa 18975 0 l_adenexa ## 21739_0_diaphragm 1 256339.2 1 21739_0_diaphragm 21739 0 diaphragm ## 21739_1_abd_wall 1 326262.6 1 21739_1_abd_wall 21739 1 abd_wall ## 22421_0_r_ovary 1 357151.6 1 22421_0_r_ovary 22421 0 r_ovary ## 22421_0_omentum 1 105110.1 1 22421_0_omentum 22421 0 omentum ## 22421_1_rectum 1 317812.7 1 22421_1_rectum 22421 1 rectum ## 27561_0_omentum 1 171759.7 1 27561_0_omentum 27561 0 omentum ## 27561_1_l_side_wall 1 708898.1 1 27561_1_l_side_wall 27561 1 l_side_wall ## 41245_0_pelvic_lymph_nodes 1 298801.8 1 41245_0_pelvic_lymph_nodes 41245 0 pelvic_lymph_nodes ## 41245_1_r_ing_lymph_node 1 225940.1 1 41245_1_r_ing_lymph_node 41245 1 r_ing_lymph_node ## 41245_1_l_ing_lymph_node 1 217242.8 1 41245_1_l_ing_lymph_node 41245 1 l_ing_lymph_node ## 27481_0_l_ovary 1 703794.9 1 27481_0_l_ovary 27481 0 l_ovary ## 28601_0_r_ovary 1 336277.8 1 28601_0_r_ovary 28601 0 r_ovary ## 28601_1_spleen 1 477668.9 1 28601_1_spleen 28601 1 spleen 8.3 Filter lowly expressed genes We use filterByExpr with the intended design to remove genes with insufficient counts. design &lt;- model.matrix(~ 0 + status +patient , data = meta) keep &lt;- edgeR::filterByExpr(dge,design,min.count = 3) dge_f &lt;- dge[keep, , keep.lib.sizes = FALSE] #if the above is too stringent because of a complicated model desitn # you can do it manually - #examples - #cpm_mat &lt;- edgeR::cpm(dge) #keep &lt;- rowSums(cpm_mat &gt; 1) &gt;= 2 #dge2 &lt;- dge[keep, , keep.lib.sizes = FALSE] dim(dge) ## [1] 33969 33 dim(dge_f) ## [1] 13041 33 #create a subset of the gene mappings counts_mapped_filtered &lt;- counts_mapped[counts_mapped$ensembl_gene_id %in% rownames(dge_f$counts),] 8.4 TMM normalization dge_f &lt;- edgeR::calcNormFactors(dge_f, method = &quot;TMM&quot;) dge_f$samples ## group lib.size norm.factors samples patient status location ## 21020_0_ovary 1 269128.9 1.1183802 21020_0_ovary 21020 0 ovary ## 24487_0_l_ovary 1 246839.7 1.0518445 24487_0_l_ovary 24487 0 l_ovary ## 24487_1_lymph_node 1 408309.5 0.3583386 24487_1_lymph_node 24487 1 lymph_node ## 25258_0_l_ovary 1 151318.5 1.2865219 25258_0_l_ovary 25258 0 l_ovary ## 25258_1_diaphragm 1 323179.2 0.9702009 25258_1_diaphragm 25258 1 diaphragm ## 29764_0_l_ovary 1 218627.9 1.3286774 29764_0_l_ovary 29764 0 l_ovary ## 30961_0_r_ovary 1 237723.3 0.7069949 30961_0_r_ovary 30961 0 r_ovary ## 32761_0_l_ovary 1 283096.9 0.9442838 32761_0_l_ovary 32761 0 l_ovary ## 37306_0_omentum 1 309561.2 0.8729862 37306_0_omentum 37306 0 omentum ## 40729_0_l_ovary 1 321724.7 0.4927415 40729_0_l_ovary 40729 0 l_ovary ## 41323_0_omentum 1 237914.4 1.4782809 41323_0_omentum 41323 0 omentum ## 45097_0_r_adnexa 1 331300.6 0.7585087 45097_0_r_adnexa 45097 0 r_adnexa ## 45097_1_lymph_node 1 355197.8 0.5759449 45097_1_lymph_node 45097 1 lymph_node ## 47573_0_l_ovary 1 261047.3 0.7880946 47573_0_l_ovary 47573 0 l_ovary ## 47573_1_lymph_node 1 310505.9 0.7400617 47573_1_lymph_node 47573 1 lymph_node ## 48986_0_r_ovary 1 262479.3 0.8240803 48986_0_r_ovary 48986 0 r_ovary ## 48986_1_abd_wall 1 237649.8 1.1680124 48986_1_abd_wall 48986 1 abd_wall ## 16030_0_l_ovary 1 272115.4 1.5391628 16030_0_l_ovary 16030 0 l_ovary ## 16030_1_pelvis 1 324798.6 1.3345744 16030_1_pelvis 16030 1 pelvis ## 18975_0_l_adenexa 1 119067.9 1.6171554 18975_0_l_adenexa 18975 0 l_adenexa ## 21739_0_diaphragm 1 252309.9 1.6376094 21739_0_diaphragm 21739 0 diaphragm ## 21739_1_abd_wall 1 320435.1 1.3771110 21739_1_abd_wall 21739 1 abd_wall ## 22421_0_r_ovary 1 354946.3 0.7873107 22421_0_r_ovary 22421 0 r_ovary ## 22421_0_omentum 1 103757.5 1.4081042 22421_0_omentum 22421 0 omentum ## 22421_1_rectum 1 314843.7 1.0694308 22421_1_rectum 22421 1 rectum ## 27561_0_omentum 1 170261.5 1.3270137 27561_0_omentum 27561 0 omentum ## 27561_1_l_side_wall 1 704486.0 0.7503250 27561_1_l_side_wall 27561 1 l_side_wall ## 41245_0_pelvic_lymph_nodes 1 296074.2 1.1194316 41245_0_pelvic_lymph_nodes 41245 0 pelvic_lymph_nodes ## 41245_1_r_ing_lymph_node 1 224107.0 1.2063735 41245_1_r_ing_lymph_node 41245 1 r_ing_lymph_node ## 41245_1_l_ing_lymph_node 1 214869.2 1.3523969 41245_1_l_ing_lymph_node 41245 1 l_ing_lymph_node ## 27481_0_l_ovary 1 700292.1 0.6820421 27481_0_l_ovary 27481 0 l_ovary ## 28601_0_r_ovary 1 331087.3 1.5555166 28601_0_r_ovary 28601 0 r_ovary ## 28601_1_spleen 1 473213.3 0.8018140 28601_1_spleen 28601 1 spleen 8.5 Exploratory MDS plot current_colors &lt;- RColorBrewer::brewer.pal(n = length(unique(meta$status)), &quot;Set2&quot;) names(current_colors) &lt;- levels(factor(meta$status)) plotMDS(dge_f, labels = meta$status, col = current_colors[meta$status], main = &quot;MDS plot (colored by status)&quot; ) legend(&quot;topright&quot;, legend = names(current_colors), col = current_colors, pch = 16, bty = &quot;n&quot; ) 8.6 Exploratory MDS plot - coloured by patient current_colors_location &lt;- colorRampPalette(RColorBrewer::brewer.pal(9, &quot;Set1&quot;))(length(unique(meta$location))) names(current_colors_location) &lt;- levels(factor(meta$location)) op &lt;- par(no.readonly = TRUE) # save graphics settings par(mar = c(5, 4, 4, 10) + 0.1) # increase right margin (last number) par(xpd = NA) # allow drawing outside plot region plotMDS(dge_f, labels = meta$location, col = current_colors_location[meta$location], main = &quot;MDS plot (colored by location)&quot; ) # legend(&quot;topright&quot;, # legend = names(current_colors_location), # col = current_colors_location, # pch = 16, # bty = &quot;n&quot; # ) legend(&quot;topright&quot;, inset = c(-0.35, 0), # push legend into the right margin legend = names(current_colors_location), col = current_colors_location, pch = 16, bty = &quot;n&quot;, cex = 0.8 ) Number of samples by region - # Count samples per location meta$location &lt;- as.character(meta$location) loc_counts &lt;- meta %&gt;% dplyr::count(location, name = &quot;n&quot;) # Plot ggplot(loc_counts, aes(x = location, y = n)) + geom_col(fill = &quot;#2C7FB8&quot;, width = 0.75) + geom_text(aes(label = n), hjust = -0.15, size = 3.8) + coord_flip() + scale_y_continuous(expand = expansion(mult = c(0, 0.12)) ) + labs( title = &quot;Number of samples by location&quot;, x = NULL, y = &quot;Number of samples&quot; ) + theme_minimal(base_size = 13) + theme( panel.grid.major.y = element_blank(), plot.title = element_text(face = &quot;bold&quot;) ) look at the different make ups of the data - What are the different locations divided by statuses? meta2 &lt;- meta %&gt;% mutate( status = factor(status, levels = 0:3), location = factor(location) ) # totals per status for labeling tot_status &lt;- meta2 %&gt;% dplyr::count(status, name = &quot;total&quot;) status_broken_into_locations &lt;- ggplot(meta2, aes(x = status, fill = location)) + geom_bar(color = &quot;white&quot;, linewidth = 0.2) + # stacked counts geom_text( data = tot_status, aes(x = status, y = total, label = total), inherit.aes = FALSE, vjust = -0.4, size = 4 ) + labs( title = &quot;Number of samples by Status (stacked by Location)&quot;, x = &quot;Status&quot;, y = &quot;Number of samples&quot;, fill = &quot;Location&quot; ) + coord_flip() + theme_minimal(base_size = 13) + theme( panel.grid.major.x = element_blank(), plot.title = element_text(face = &quot;bold&quot;) ) + expand_limits(y = max(tot_status$total) * 1.08) status_broken_into_locations What are the different status divided by locations? meta2$location &lt;- factor(meta$location, levels = names(sort(table(meta$location), decreasing = TRUE))) tot_loc &lt;- meta2 %&gt;% dplyr::count(location, name = &quot;total&quot;) locations_broken_into_statuses &lt;- ggplot(meta2, aes(x = location, fill = status)) + geom_bar(color = &quot;white&quot;, linewidth = 0.2) + coord_flip() + geom_text( data = tot_loc %&gt;% mutate(location = location), aes(x = location, y = total, label = total), inherit.aes = FALSE, hjust = -0.15, size = 3.8 ) + labs( title = &quot;Number of samples by Location (stacked by Status)&quot;, x = &quot;Location&quot;, y = &quot;Number of samples&quot;, fill = &quot;Status&quot; ) + theme_minimal(base_size = 13) + theme( panel.grid.major.y = element_blank(), plot.title = element_text(face = &quot;bold&quot;) ) + expand_limits(y = max(tot_loc$total) * 1.08) locations_broken_into_statuses 8.7 log-CPM for visualization lcpm &lt;- edgeR::cpm(dge_f, log = TRUE, prior.count = 1) summary(as.vector(lcpm)) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 1.753 3.035 3.891 4.029 4.820 20.588 8.8 Save for downstream chapters saveRDS(list(dge_f = dge_f, meta = meta, design = design, lcpm = lcpm, mappings = mappings), file = &quot;data/d2_qc_objects.rds&quot;) "],["limma-voom_dataset2.html", "Chapter 9 Differential expression with limma-voom - Dataset 2 9.1 Results tables 9.2 Volcano plot (0 vs rest) 9.3 Save limma results", " Chapter 9 Differential expression with limma-voom - Dataset 2 In this chapter we run limma-voom, which: Starts from raw counts Transforms to log2-CPM with precision weights (voom()) Fits a linear model + empirical Bayes moderation We use an additive model: \\[ \\text{expression} \\sim \\text{cellline} + \\text{treatment} \\] This estimates treatment effects while controlling for baseline differences between cell lines. obj &lt;- readRDS(&quot;data/d2_qc_objects.rds&quot;) dge_f &lt;- obj$dge_f meta &lt;- obj$meta mappings &lt;- obj$mappings design &lt;- obj$design v &lt;- limma::voom(dge_f, design, plot = TRUE) fit &lt;- limma::lmFit(v, design) fit &lt;- limma::eBayes(fit, trend = TRUE) # Contrasts contr &lt;- limma::makeContrasts( `status0` = status0 - (status1), levels = design ) fit2 &lt;- limma::contrasts.fit(fit, contr) fit2 &lt;- limma::eBayes(fit2, trend = TRUE) 9.1 Results tables res_0_vs_1 &lt;- limma::topTable(fit2, coef = &quot;status0&quot;, number = Inf, sort.by = &quot;P&quot;) head(res_0_vs_1 ) ## logFC AveExpr t P.Value adj.P.Val B ## ENSG00000151729.10 0.7716211 3.208481 4.456881 0.0003039356 0.9668082 -3.490636 ## ENSG00000213316.9 1.0587958 2.072318 4.216054 0.0005182912 0.9668082 -3.685744 ## ENSG00000138829.11 -1.3959423 2.556387 -4.213800 0.0005208933 0.9668082 -3.633678 ## ENSG00000113328.18 0.6185947 6.437853 4.105158 0.0006632631 0.9668082 -3.705772 ## ENSG00000211956.2 2.0603342 2.117546 4.102268 0.0006675426 0.9668082 -3.659265 ## ENSG00000152092.15 0.8195556 1.580981 4.088099 0.0006889341 0.9668082 -3.703961 9.2 Volcano plot (0 vs rest) volcano_df &lt;- res_0_vs_1 %&gt;% rownames_to_column(&quot;ensembl&quot;) %&gt;% mutate(sig = adj.P.Val &lt; 0.05) ggplot(volcano_df, aes(x = logFC, y = -log10(P.Value), color = sig)) + geom_point(alpha = 0.6) + theme_minimal() + labs( title = &quot;limma-voom: res_0_vs_1 &quot;, x = &quot;log2 fold-change&quot;, y = &quot;-log10(p-value)&quot; ) 9.3 Save limma results saveRDS( list( meta = meta, mappings = mappings, fit2 = fit2, res_0_vs_1 = res_0_vs_1 ), file = &quot;data/d2_limma_results.rds&quot; ) "],["edger_dataset2.html", "Chapter 10 Differential expression with edgeR (QLF) - Dataset 2 10.1 Plot Biological coefficient of variance plot 10.2 Test: status 0 vs status 1 10.3 Extract full results 10.4 Volcano plot of EdgeR results 10.5 Try and run glmFit 10.6 Test: status 0 vs status 1 10.7 Save edgeR results", " Chapter 10 Differential expression with edgeR (QLF) - Dataset 2 In this chapter we run edgeR using the recommended quasi-likelihood pipeline: Start from raw counts in a DGEList Estimate dispersions Fit a QL GLM Perform QL F-tests for contrasts of interest We use the same additive design: \\[ \\text{counts} \\sim \\text{status} + \\text{patient} \\] obj &lt;- readRDS(&quot;data/d2_qc_objects.rds&quot;) dge_f &lt;- obj$dge_f meta &lt;- obj$meta mappings &lt;- obj$mappings design &lt;- obj$design # Contrasts contr &lt;- limma::makeContrasts( `status0vs1` = status0 - (status1), levels = design ) # Estimate dispersion and fit QL model edge &lt;- edgeR::estimateDisp(dge_f, design) fit &lt;- edgeR::glmQLFit(edge, design) 10.1 Plot Biological coefficient of variance plot plotBCV(edge) 10.2 Test: status 0 vs status 1 qlf_0_vs_1 &lt;- edgeR::glmQLFTest(fit, contrast = contr[, &quot;status0vs1&quot;]) edgeR::topTags(qlf_0_vs_1) ## Coefficient: 1*status0 -1*status1 ## logFC logCPM F PValue FDR ## ENSG00000240429.1 -1.1832705 3.671905 29.34794 1.145213e-05 0.06015600 ## ENSG00000138829.11 -1.9731998 3.991667 34.33254 1.308962e-05 0.06015600 ## ENSG00000221867.8 3.1695213 3.122014 78.27375 1.742877e-05 0.06015600 ## ENSG00000196604.12 -1.6168936 3.867533 28.54729 2.170176e-05 0.06015600 ## ENSG00000151729.10 0.9484458 3.946041 27.69842 2.306418e-05 0.06015600 ## ENSG00000157429.15 -0.7927040 3.495731 22.82475 3.820839e-05 0.08271539 ## ENSG00000162998.4 -1.5853343 3.385425 26.06719 4.439903e-05 0.08271539 ## ENSG00000240382.3 4.4279973 5.238228 31.24078 7.216175e-05 0.10844245 ## ENSG00000013297.11 1.7036739 3.566455 22.57187 7.483951e-05 0.10844245 ## ENSG00000211956.2 3.4714536 4.407648 24.55495 1.140482e-04 0.14168075 10.3 Extract full results tab_0_vs_1 &lt;- edgeR::topTags(qlf_0_vs_1, n = Inf)$table %&gt;% rownames_to_column(&quot;ensembl&quot;) head(tab_0_vs_1) ## ensembl logFC logCPM F PValue FDR ## 1 ENSG00000240429.1 -1.1832705 3.671905 29.34794 1.145213e-05 0.06015600 ## 2 ENSG00000138829.11 -1.9731998 3.991667 34.33254 1.308962e-05 0.06015600 ## 3 ENSG00000221867.8 3.1695213 3.122014 78.27375 1.742877e-05 0.06015600 ## 4 ENSG00000196604.12 -1.6168936 3.867533 28.54729 2.170176e-05 0.06015600 ## 5 ENSG00000151729.10 0.9484458 3.946041 27.69842 2.306418e-05 0.06015600 ## 6 ENSG00000157429.15 -0.7927040 3.495731 22.82475 3.820839e-05 0.08271539 10.4 Volcano plot of EdgeR results volcano_df &lt;- tab_0_vs_1 %&gt;% mutate(sig = FDR &lt; 0.05) ggplot(volcano_df, aes(x = logFC, y = -log10(PValue), color = sig)) + geom_point(alpha = 0.6) + theme_minimal() + labs( title = &quot;EdgeR: 0 vs 1&quot;, x = &quot;log2 fold-change&quot;, y = &quot;-log10(p-value)&quot; ) 10.5 Try and run glmFit 10.6 Test: status 0 vs status 1 glmfit_0_vs_1 &lt;- edgeR::glmFit(edge, design) glmtest_0_vs_1 &lt;- edgeR::glmLRT(fit, contrast = contr[, &quot;status0vs1&quot;]) edgeR::topTags(glmtest_0_vs_1) ## Coefficient: 1*status0 -1*status1 ## logFC logCPM LR PValue FDR ## ENSG00000240382.3 4.427997 5.238228 56.76214 4.918460e-14 6.414164e-10 ## ENSG00000211947.2 3.587843 5.992715 55.36579 1.000628e-13 6.524593e-10 ## ENSG00000211663.2 3.466166 4.997326 49.14025 2.382995e-12 1.035888e-08 ## ENSG00000224650.2 3.397552 4.693907 39.47905 3.315983e-10 9.979335e-07 ## ENSG00000211956.2 3.471454 4.407648 39.19962 3.826139e-10 9.979335e-07 ## ENSG00000283029.1 -1.902125 16.790777 37.62136 8.589875e-10 1.867009e-06 ## ENSG00000243290.3 3.048243 4.133752 36.58053 1.464875e-09 2.729062e-06 ## ENSG00000276775.1 2.787666 5.156642 36.04396 1.929157e-09 3.144766e-06 ## ENSG00000112936.18 2.768605 5.273166 35.43942 2.631083e-09 3.812439e-06 ## ENSG00000102837.6 -4.896848 4.754747 34.84953 3.561951e-09 4.645140e-06 glm_tab_0_vs_1 &lt;- edgeR::topTags(glmtest_0_vs_1, n = Inf)$table %&gt;% rownames_to_column(&quot;ensembl&quot;) tab_glm &lt;- glm_tab_0_vs_1 %&gt;% rownames_to_column(&quot;gene&quot;) %&gt;% mutate( neglog10P = -log10(PValue), direction = case_when( FDR &lt; 0.05 &amp; logFC &gt; 0 ~ &quot;Up&quot;, FDR &lt; 0.05 &amp; logFC &lt; 0 ~ &quot;Down&quot;, TRUE ~ &quot;Not sig&quot; ) ) ggplot(tab, aes(x = logFC, y = neglog10P)) + geom_point(aes(color = direction), alpha = 0.7, size = 1.2) + scale_color_manual(values = c( &quot;Up&quot; = &quot;red&quot;, &quot;Down&quot; = &quot;blue&quot;, &quot;Not sig&quot; = &quot;grey70&quot; )) + geom_vline(xintercept = c(-1, 1), linetype = &quot;dashed&quot;, color = &quot;steelblue&quot;) + geom_hline(yintercept = -log10(0.05), linetype = &quot;dashed&quot;, color = &quot;steelblue&quot;) + theme_minimal() + labs( title = &quot;edgeR volcano: 0 vs rest&quot;, x = &quot;log2 fold change (logFC)&quot;, y = &quot;-log10(p-value)&quot;, color = NULL ) 10.7 Save edgeR results saveRDS( list( meta = meta, mappings = mappings, fit = fit, qlf_0_vs_1 = qlf_0_vs_1 , glm_tab_0_vs_1 = glm_tab_0_vs_1 ), file = &quot;data/d2_edger_results.rds&quot; ) "],["deseq2_dataset2.html", "Chapter 11 Differential expression with DESeq2 - Dataset 2 11.1 Results 11.2 Volcano (red=up, blue=down)", " Chapter 11 Differential expression with DESeq2 - Dataset 2 DESeq2 performs differential expression analysis for RNA-seq count data. We are assuming here that the counts data are estimated counts exported from salmon - but that is not guarenteed. DESeq requires count data - specifically integer count data (not an estimated version). We will round these numbers but this is not ideal. You should ideally have count data. If you have TPM, (or RPKM, or FPKM) your real only route is to use limma as both edgeR and DESEq2 require raw counts. obj &lt;- readRDS(&quot;data/d2_qc_objects.rds&quot;) dge_f &lt;- obj$dge_f meta &lt;- obj$meta design = obj$design ## but DESeq requires the formula and not the model.matrix object ## below we put the formula in directly library(DESeq2) count_mat &lt;- round(dge_f$counts) dds &lt;- DESeqDataSetFromMatrix( countData = count_mat, colData = as.data.frame(meta), design = ~ 0 + status ) dds &lt;- DESeq(dds) 11.1 Results res_0_vs_1 &lt;- results(dds,contrast = c(&quot;status&quot;,&quot;0&quot;,&quot;1&quot;)) summary(res_20_vs_nt) ## ## out of 14704 with nonzero total read count ## adjusted p-value &lt; 0.1 ## LFC &gt; 0 (up) : 541, 3.7% ## LFC &lt; 0 (down) : 225, 1.5% ## outliers [1] : 0, 0% ## low counts [2] : 0, 0% ## (mean count &lt; 4) ## [1] see &#39;cooksCutoff&#39; argument of ?results ## [2] see &#39;independentFiltering&#39; argument of ?results 11.2 Volcano (red=up, blue=down) library(ggplot2) library(dplyr) library(tibble) vol &lt;- as.data.frame(res_0_vs_1) %&gt;% rownames_to_column(&quot;gene&quot;) %&gt;% mutate( neglog10p = -log10(pvalue), direction = case_when( !is.na(padj) &amp; padj &lt; 0.05 &amp; log2FoldChange &gt; 0 ~ &quot;Up&quot;, !is.na(padj) &amp; padj &lt; 0.05 &amp; log2FoldChange &lt; 0 ~ &quot;Down&quot;, TRUE ~ &quot;Not sig&quot; ) ) ggplot(vol, aes(log2FoldChange, neglog10p)) + geom_point(aes(color = direction), alpha = 0.7, size = 1.2) + scale_color_manual(values = c(Up = &quot;red&quot;, Down = &quot;blue&quot;, `Not sig` = &quot;grey70&quot;)) + theme_minimal() + labs(title = &quot;DESeq2: 0 vs 1&quot;, x = &quot;log2 FC&quot;, y = &quot;-log10(p)&quot;, color = NULL) saveRDS(list(meta = meta, dds = dds, res_20_vs_nt = res_20_vs_nt, res_3_vs_nt = res_3_vs_nt, res_20_vs_3 = res_20_vs_3), file = &quot;data/d2_deseq2_results.rds&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
